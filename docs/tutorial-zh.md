# 前端监控系统教程 📊

## 系统概览：我们构建了什么

让我通过循序渐进的教程方式，配合可视化图表，为您详细介绍我们刚刚创建的企业级前端监控系统。

## 🏗️ 系统架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                    前端监控系统                                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌──────────────┐    ┌─────────────────┐     │
│  │   浏览器    │───→│   数据网关    │───→│    消息队列     │     │
│  │   (SDK)     │    │   (Nginx)    │    │   (Kafka)      │     │
│  └─────────────┘    └──────────────┘    └─────────────────┘     │
│                                                   │             │
│                                                   ▼             │
│  ┌─────────────┐    ┌──────────────┐    ┌─────────────────┐     │
│  │   仪表板    │◄───│  API服务层   │◄───│   数据处理      │     │
│  │  (React)    │    │ (GraphQL)    │    │   (Flink)      │     │
│  └─────────────┘    └──────────────┘    └─────────────────┘     │
│                              │                   │             │
│                              ▼                   ▼             │
│                     ┌─────────────────────────────────────┐     │
│                     │           存储层                    │     │
│                     │ ┌─────────┐ ┌─────────┐ ┌─────────┐│     │
│                     │ │InfluxDB │ │ElasticSearch│ │PostgreSQL││     │
│                     │ │(指标数据)│ │  (日志数据) │ │(配置数据)││     │
│                     │ └─────────┘ └─────────┘ └─────────┘│     │
│                     └─────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────┘
```

## 📚 第一步：理解核心组件

### 1.1 前端SDK（数据收集层）

SDK是我们监控系统的核心。它是一个运行在用户浏览器中的轻量级JavaScript库。

```typescript
// SDK架构
┌─────────────────────────────────────────┐
│              前端SDK                     │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────────┐  ┌─────────────────┐   │
│  │   性能      │  │    错误追踪     │   │
│  │  收集器     │  │    收集器       │   │
│  └─────────────┘  └─────────────────┘   │
│                                         │
│  ┌─────────────┐  ┌─────────────────┐   │
│  │   行为      │  │   会话重放      │   │
│  │  收集器     │  │   收集器        │   │
│  └─────────────┘  └─────────────────┘   │
│                                         │
│  ┌─────────────────────────────────────┐ │
│  │        数据收集器核心                │ │
│  │  ┌─────────┐ ┌─────────┐ ┌───────┐  │ │
│  │  │  队列   │ │  传输   │ │ 存储  │  │ │
│  │  └─────────┘ └─────────┘ └───────┘  │ │
│  └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

**核心特性：**
- **模块化设计**：每个收集器处理特定类型的数据
- **轻量级**：压缩后 < 50KB
- **智能批处理**：发送前合并事件
- **离线支持**：网络不可用时缓存数据

### 1.2 逐步解析：数据如何流转

```
第一步：事件发生
┌─────────────────┐
│ 用户点击        │
│ 按钮            │
└─────────────────┘
         │
         ▼
第二步：SDK捕获
┌─────────────────┐
│ 行为收集器      │
│ 捕获点击        │
│ 事件            │
└─────────────────┘
         │
         ▼
第三步：事件处理
┌─────────────────┐
│ 数据收集器      │
│ 添加到队列      │
└─────────────────┘
         │
         ▼
第四步：批量传输
┌─────────────────┐
│ HTTP传输器      │
│ 发送批量数据    │
│ 到后端          │
└─────────────────┘
```

## 📚 第二步：SDK模块深度解析

### 2.1 性能监控模块

该模块自动追踪网页性能指标：

```typescript
// 测量的指标：
┌─────────────────────────────────────────────────────────────┐
│                    性能指标                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  核心Web性能指标：              自定义指标：                │
│  ┌─────────────────┐           ┌─────────────────┐          │
│  │ LCP: 2.5s       │           │ API调用: 300ms  │          │
│  │ FID: 100ms      │           │ 数据库查询: 150ms│          │
│  │ CLS: 0.1        │           │ 自定义: 250ms   │          │
│  │ FCP: 1.8s       │           └─────────────────┘          │
│  │ TTFB: 200ms     │                                        │
│  └─────────────────┘                                        │
│                                                             │
│  页面性能：                    资源加载：                   │
│  ┌─────────────────┐           ┌─────────────────┐          │
│  │ 页面加载: 3.2s  │           │ JS文件: 500ms   │          │
│  │ DOM就绪: 2.1s   │           │ CSS文件: 200ms  │          │
│  │ 可交互: 3s      │           │ 图片: 800ms     │          │
│  └─────────────────┘           └─────────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

**工作原理：**
1. **Performance Observer API**：监听浏览器性能事件
2. **Navigation Timing**：捕获页面加载指标
3. **Resource Timing**：追踪单个资源加载
4. **自定义标记**：允许手动性能测量

```typescript
// 使用示例：
Monitor.mark('api-call-start');
// ... 进行API调用
Monitor.mark('api-call-end');
Monitor.measure('api-duration', 'api-call-start', 'api-call-end');
```

### 2.2 错误追踪模块

自动捕获并报告所有类型的错误：

```
错误捕获流程：
┌─────────────────────────────────────────────────────────────┐
│                    错误来源                                  │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  JavaScript错误：            网络错误：                    │
│  ┌─────────────────┐         ┌─────────────────┐           │
│  │ • 语法错误      │         │ • 404未找到     │           │
│  │ • 类型错误      │  ────→  │ • 500服务器错误 │  ────→    │
│  │ • 引用错误      │         │ • 超时错误      │           │
│  └─────────────────┘         └─────────────────┘           │
│                                                             │
│  Promise拒绝：               资源加载错误：                │
│  ┌─────────────────┐         ┌─────────────────┐           │
│  │ • 未处理拒绝    │         │ • 图片404       │           │
│  │ • 异步错误      │  ────→  │ • 脚本404       │  ────→    │
│  │ • API失败       │         │ • CSS 404       │           │
│  └─────────────────┘         └─────────────────┘           │
│                                      │                      │
│                                      ▼                      │
│                           ┌─────────────────┐               │
│                           │   错误收集器    │               │
│                           │ • 去重处理      │               │
│                           │ • 严重程度分级  │               │
│                           │ • 上下文信息    │               │
│                           └─────────────────┘               │
└─────────────────────────────────────────────────────────────┘
```

**智能特性：**
- **去重处理**：防止重复错误的垃圾信息
- **上下文捕获**：包含导致错误的用户操作
- **严重程度分类**：自动分类错误重要性
- **隐私保护**：在堆栈跟踪中掩盖敏感数据

### 2.3 行为追踪模块

捕获用户交互和页面导航：

```
用户行为追踪：
┌─────────────────────────────────────────────────────────────┐
│                    追踪的交互                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  鼠标事件：                  键盘事件：                     │
│  ┌─────────────────┐         ┌─────────────────┐           │
│  │ • 点击          │         │ • 按键          │           │
│  │ • 悬停          │  ────→  │ • 表单输入      │  ────→    │
│  │ • 鼠标移动      │         │ • 快捷键        │           │
│  └─────────────────┘         └─────────────────┘           │
│                                                             │
│  滚动事件：                  导航事件：                     │
│  ┌─────────────────┐         ┌─────────────────┐           │
│  │ • 页面滚动      │         │ • 页面变化      │           │
│  │ • 元素滚动      │  ────→  │ • 历史导航      │  ────→    │
│  │ • 滚动深度      │         │ • 哈希变化      │           │
│  └─────────────────┘         └─────────────────┘           │
│                                      │                      │
│                                      ▼                      │
│                           ┌─────────────────┐               │
│                           │   行为收集器    │               │
│                           │ • 节流处理      │               │
│                           │ • 隐私掩码      │               │
│                           │ • 路径追踪      │               │
│                           └─────────────────┘               │
└─────────────────────────────────────────────────────────────┘
```

**隐私优先：**
- **输入掩码**：自动隐藏敏感表单数据
- **采样**：可配置的数据收集率
- **退出选项**：用户可以禁用追踪

### 2.4 会话重放模块

记录用户会话以供调试：

```
会话重放架构：
┌─────────────────────────────────────────────────────────────┐
│                    DOM记录                                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  DOM变更：                   用户交互：                     │
│  ┌─────────────────┐         ┌─────────────────┐           │
│  │ • 节点添加      │         │ • 鼠标点击      │           │
│  │ • 节点删除      │  ────→  │ • 滚动事件      │  ────→    │
│  │ • 属性变化      │         │ • 输入变化      │           │
│  └─────────────────┘         └─────────────────┘           │
│                                                             │
│  视口变化：                  样式变化：                     │
│  ┌─────────────────┐         ┌─────────────────┐           │
│  │ • 窗口大小调整  │         │ • CSS更新       │           │
│  │ • 屏幕方向      │  ────→  │ • 类名变化      │  ────→    │
│  │ • 缩放级别      │         │ • 样式属性      │           │
│  └─────────────────┘         └─────────────────┘           │
│                                      │                      │
│                                      ▼                      │
│                           ┌─────────────────┐               │
│                           │   重放记录器    │               │
│                           │ • 压缩          │               │
│                           │ • 加密          │               │
│                           │ • 净化处理      │               │
│                           └─────────────────┘               │
└─────────────────────────────────────────────────────────────┘
```

## 📚 第三步：数据处理管道

### 3.1 Apache Flink实时处理

```
实时流处理：
┌─────────────────────────────────────────────────────────────┐
│                    Flink处理                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  输入流 (Kafka)：                                          │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ 事件1 → 事件2 → 事件3 → 事件4 → 事件5 → ...           ││
│  └─────────────────────────────────────────────────────────┘│
│                              │                              │
│                              ▼                              │
│  处理窗口 (1分钟)：                                        │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐│
│  │     窗口 1      │ │     窗口 2      │ │     窗口 3      ││
│  │ ┌─────┐ ┌─────┐ │ │ ┌─────┐ ┌─────┐ │ │ ┌─────┐ ┌─────┐ ││
│  │ │事件 │ │事件 │ │ │ │事件 │ │事件 │ │ │ │事件 │ │事件 │ ││
│  │ │  1  │ │  2  │ │ │ │  3  │ │  4  │ │ │ │  5  │ │  6  │ ││
│  │ └─────┘ └─────┘ │ │ └─────┘ └─────┘ │ │ └─────┘ └─────┘ ││
│  └─────────────────┘ └─────────────────┘ └─────────────────┘│
│           │                   │                   │         │
│           ▼                   ▼                   ▼         │
│  ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐│
│  │   聚合指标      │ │   聚合指标      │ │   聚合指标      ││
│  │ • 平均: 250ms   │ │ • 平均: 300ms   │ │ • 平均: 275ms   ││
│  │ • P95: 500ms    │ │ • P95: 600ms    │ │ • P95: 550ms    ││
│  │ • 计数: 1500    │ │ • 计数: 1200    │ │ • 计数: 1800    ││
│  └─────────────────┘ └─────────────────┘ └─────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### 3.2 存储策略

```
多层存储架构：
┌─────────────────────────────────────────────────────────────┐
│                    存储层                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  热数据 (InfluxDB)：            温数据 (Elasticsearch)：   │
│  ┌─────────────────┐             ┌─────────────────┐       │
│  │ • 最近7天       │             │ • 最近30天      │       │
│  │ • 高频率查询    │     ────→   │ • 搜索/过滤     │ ────→ │
│  │ • 快速查询      │             │ • 错误日志      │       │
│  └─────────────────┘             └─────────────────┘       │
│                                                             │
│  冷数据 (PostgreSQL)：          归档 (S3)：                │
│  ┌─────────────────┐             ┌─────────────────┐       │
│  │ • 配置数据      │             │ • 旧会话        │       │
│  │ • 用户元数据    │     ────→   │ • 合规性        │ ────→ │
│  │ • 关系数据      │             │ • 长期存储      │       │
│  └─────────────────┘             └─────────────────┘       │
└─────────────────────────────────────────────────────────────┘
```

## 📚 第四步：实际使用示例

### 4.1 基础SDK集成

```html
<!-- 第一步：引入SDK -->
<script src="https://cdn.example.com/monitor-sdk/latest/monitor.min.js"></script>

<script>
// 第二步：使用您的配置初始化
Monitor.init({
  appId: 'your-app-id',
  apiKey: 'your-api-key', 
  endpoint: 'https://api.yourmonitor.com/collect',
  
  // 第三步：配置功能
  features: {
    performance: true,  // 追踪页面速度
    errors: true,      // 捕获错误
    behavior: true,    // 用户交互
    replay: false      // 会话录制
  }
});

// 第四步：设置用户上下文
Monitor.setUser('user-123', {
  email: 'user@example.com',
  plan: 'premium'
});

// 第五步：追踪自定义事件
Monitor.track('purchase_completed', {
  amount: 99.99,
  product: 'premium_plan'
});
</script>
```

### 4.2 高级使用模式

```typescript
// 性能监控
Monitor.mark('checkout-start');
// ... 结账流程
Monitor.mark('checkout-end');
Monitor.measure('checkout-duration', 'checkout-start', 'checkout-end');

// 错误处理
try {
  await processPayment();
} catch (error) {
  Monitor.captureException(error, {
    context: 'payment_processing',
    amount: orderTotal,
    paymentMethod: 'credit_card'
  }, 'high');
}

// 自定义事件追踪
Monitor.track('feature_used', {
  feature: 'advanced_search',
  filters_applied: 3,
  results_count: 42
});
```

## 📚 第五步：仪表板和分析

### 5.1 实时仪表板

```
仪表板布局：
┌─────────────────────────────────────────────────────────────┐
│                    监控仪表板                                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  关键指标：                                                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐│
│  │ 页面加载    │ │ 错误率      │ │ 活跃用户    │ │ 运行时间││
│  │    2.3s     │ │    0.2%     │ │    1,247    │ │ 99.9%   ││
│  │   ↓ 15%     │ │   ↓ 45%     │ │   ↑ 12%     │ │  ● 运行 ││
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘│
│                                                             │
│  性能趋势：                                                │
│  ┌─────────────────────────────────────────────────────────┐│
│  │   加载时间 (ms)                                         ││
│  │ 3000 ┤                                                  ││
│  │      │     ●                                            ││
│  │ 2500 ┤   ●   ●                                          ││
│  │      │ ●       ●                                        ││
│  │ 2000 ┤           ●                                      ││
│  │      │             ●   ●                                ││
│  │ 1500 ┤               ●   ●                              ││
│  │      └─┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┤││
│  │        12pm  1pm  2pm  3pm  4pm  5pm  6pm  7pm  8pm   ││
│  └─────────────────────────────────────────────────────────┘│
│                                                             │
│  最近错误：                                                │
│  ┌─────────────────────────────────────────────────────────┐│
│  │ TypeError: 无法读取属性 'user'         │ 12 次          ││
│  │ Network Error: API获取失败             │  8 次          ││
│  │ ReferenceError: analytics 未定义      │  5 次          ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
```

### 5.2 告警配置

```typescript
// 智能告警规则
const alertRules = [
  {
    name: '高错误率告警',
    metric: 'error_rate',
    condition: 'greater_than',
    threshold: 5, // 5%错误率
    duration: '5m',
    severity: 'critical',
    notifications: ['email', 'slack']
  },
  {
    name: '页面加载缓慢',
    metric: 'page_load_time',
    condition: 'p95_greater_than',
    threshold: 3000, // 3秒
    duration: '10m',
    severity: 'warning',
    notifications: ['slack']
  }
];
```

## 🎯 核心优势和使用场景

### 优势：
1. **实时洞察**：立即了解用户体验状况
2. **主动问题检测**：在用户投诉前发现问题
3. **数据驱动优化**：基于数据进行性能改进
4. **增强调试能力**：重放用户会话以重现问题
5. **商业智能**：了解用户行为模式

### 使用场景：
- **电子商务**：追踪结账漏斗性能
- **SaaS应用**：监控功能采用和用户参与度
- **内容网站**：优化页面加载时间和用户参与度
- **移动网页**：了解移动端特定的性能问题

## 🚀 下一步

1. **部署SDK**到您的生产环境
2. **配置仪表板**满足您团队的特定需求
3. **设置告警**针对关键性能和错误阈值
4. **培训您的团队**使用监控数据
5. **迭代改进**基于收集的洞察

这个监控系统为您的前端应用提供了全面的可见性，使您能够通过数据驱动的优化提供卓越的用户体验！

## 📄 附录：完整配置示例

### A.1 完整SDK配置

```typescript
Monitor.init({
  // 基础配置
  appId: 'your-app-id',
  apiKey: 'your-api-key',
  endpoint: 'https://api.yourmonitor.com/collect',
  
  // 功能开关
  features: {
    performance: true,    // 性能监控
    errors: true,        // 错误追踪
    behavior: true,      // 行为分析
    replay: false        // 会话重放
  },
  
  // 采样配置
  sampling: {
    performance: 1,      // 100% 采样
    errors: 1,          // 100% 采样
    behavior: 0.1,      // 10% 采样
    replay: 0.01        // 1% 采样
  },
  
  // 数据上报配置
  reporting: {
    batchSize: 50,       // 批量大小
    flushInterval: 5000, // 上报间隔(ms)
    maxRetries: 3,       // 最大重试次数
    timeout: 10000       // 请求超时
  },
  
  // 隐私配置
  privacy: {
    maskSensitiveData: true,           // 脱敏敏感数据
    allowedDomains: ['*.example.com'], // 允许的域名
    blockedElements: ['.sensitive']    // 屏蔽的元素
  },
  
  // 调试配置
  debug: false,
  environment: 'production'
});
```

### A.2 错误处理最佳实践

```typescript
// 1. 全局错误处理
window.addEventListener('error', (event) => {
  Monitor.captureException(event.error, {
    type: 'global_error',
    filename: event.filename,
    lineno: event.lineno,
    colno: event.colno
  });
});

// 2. Promise rejection处理
window.addEventListener('unhandledrejection', (event) => {
  Monitor.captureException(new Error(event.reason), {
    type: 'unhandled_promise_rejection',
    reason: event.reason
  });
});

// 3. 自定义错误边界
class ErrorBoundary {
  componentDidCatch(error, errorInfo) {
    Monitor.captureException(error, {
      type: 'react_error_boundary',
      componentStack: errorInfo.componentStack
    });
  }
}

// 4. API错误处理
async function apiCall(url, options) {
  try {
    const response = await fetch(url, options);
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    return response.json();
  } catch (error) {
    Monitor.captureException(error, {
      type: 'api_error',
      url,
      method: options?.method || 'GET',
      status: error.status
    });
    throw error;
  }
}
```

### A.3 性能优化技巧

```typescript
// 1. 懒加载监控
const initMonitoring = () => {
  if (document.readyState === 'complete') {
    Monitor.init(config);
  } else {
    window.addEventListener('load', () => Monitor.init(config));
  }
};

// 2. 条件加载
if (process.env.NODE_ENV === 'production') {
  initMonitoring();
}

// 3. 采样策略
const shouldSample = () => {
  // 对新用户100%采样，老用户10%采样
  const isNewUser = !localStorage.getItem('returning_user');
  return isNewUser ? 1 : 0.1;
};

Monitor.init({
  ...config,
  sampling: {
    performance: shouldSample(),
    errors: 1, // 错误始终100%采样
    behavior: shouldSample() * 0.5
  }
});

// 4. 智能批处理
Monitor.init({
  ...config,
  reporting: {
    batchSize: window.navigator.connection?.effectiveType === '4g' ? 100 : 20,
    flushInterval: document.visibilityState === 'visible' ? 5000 : 30000
  }
});
```

这个完整的教程为您提供了理解和实施前端监控系统所需的所有知识！